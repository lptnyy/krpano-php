<!DOCTYPE html><head><title>Convert</title><link rel="stylesheet" href="../design/style.css"><style>html{height:100%}body{height:100%;margin:0;padding:0}::-webkit-scrollbar-track{background:0 0}::-webkit-scrollbar{width:10px;height:0;background:0 0}::-webkit-scrollbar-thumb{background-color:rgba(255,255,255,.2);border-radius:10px}</style><script src="../cube_sphere_detector.js"></script></head><body><div id="convertframe" style="position:absolute;width:100%;height:100%;display:table" onselectstart="return false"><div id="cf_top" style="display:table-row; xbackground-color:#FFFF77"><div style="color:#336699;margin:10px"><b>Convert Tool</b> - Drop here spherical or cubical panoramic images and they will get automatically converted to each other.</div></div><div style="display:table-row;height:100%; xbackground-color:#77FFFF"><table style="table-layout:fixed;font-size:inherit;margin:0;padding:0 0px;width:100%;height:100%" cellspacing="0"><tr style="height:100%;overflow:auto"><td id="cf_wnd" style="margin:0px;padding:0px 10px 10px 10px;vertical-align:top"><div id="dropletcontainer" style="overflow:scroll;position:relative;box-sizing:border-box;width:100%;height:100%;border:1px solid silver;background: radial-gradient(ellipse at center, rgba(76,76,76,1) 0%,rgba(89,89,89,1) 0%,rgba(17,17,17,1) 100%)"><div id="convertdroplet" style="pointer-events:none;position:absolute;left:50%;top:50%;margin-left:-180px;padding-top:80px;margin-top:-180px;width:360px;xheight:360px;xoutline:1px solid red; color:#FFFFFF; text-shadow:-1px -1px 0.5px rgba(0,0,0,0.25), 0px -1px 0.5px rgba(0,0,0,0.25), +1px -1px 0.5px rgba(0,0,0,0.25), -1px  0px 0.5px rgba(0,0,0,0.25), +1px  0px 0.5px rgba(0,0,0,0.25), -1px +1px 0.5px rgba(0,0,0,0.25), 0px +1px 0.5px rgba(0,0,0,0.25), +1px +1px 0.5px rgba(0,0,0,0.25); transition:padding-top 0.5s"><div style="width:100%;text-align:center"><div id="dropinfo" style="pointer-events:none"><img src="../design/ico-convert48.png"><br><span style="font-size:20px">SPHERE to CUBE<br>CUBE to SPHERE<br><small>Drop spherical or cubical images here to convert them to each other.</small><br><br></span></div><div id="convertlog" style="pointer-events:none;xdisplay:none;text-align:center;xbackground:rgba(255,255,255,0.1);opacity:1.0; transition:opacity 0.5s"><div id="processing_info" style="padding-bottom:4px">&nbsp;</div><table id="convert_table" style="width:100%;table-layout:fixed;text-align:left" cellspacing="0"></table></div></div></div></div></td></tr></table></div><div id="cf_bottom" style="display:table-row; xbackground-color:green"><div style="margin:0 10px 10px 10px;xoutline:1px solid red"><span style="color:#336699">Conversion settings:</span><br><table style="font-size:inherit;padding:0;margin:0;margin-top:5px" cellspacing="0"><tr><td><label for="m_outsize" style="vertical-align:middle">Output Size:</label></td><td><input id="m_outsize" type="text" value="100%" style="width:60px; vertical-align:middle; padding:0 3px; margin:0px" onchange="on_outsize_change()"><span id="m_outsize_info" style="color:#336699;padding-left:2px;vertical-align:middle">Use percent or absolute sizes.</span><br></td></tr><tr><td><label for="m_imageformat" style="vertical-align:middle">Image Format:</label></td><td><select id="m_imageformat" style="vertical-align:middle;width:200px" onchange="on_imageformat_change()"><option value="JPEGS">JPEG Standard (.jpg)</option><option value="JPEGO">JPEG Optimized (.jpg)</option><option value="JPEGP">JPEG Progressive (.jpg)</option><option value="TIFFA" selected="selected">TIFF Auto (.tif)</option><option value="TIFFU">TIFF Uncompressed (.tif)</option><option value="TIFFL">TIFF LZW (.tif)</option><option value="TIFFZ">TIFF ZIP (.tif)</option><option value="BTIFFA">BigTIFF Auto (.bigtiff)</option><option value="BTIFFU">BigTIFF Uncompressed (.bigtiff)</option><option value="BTIFFL">BigTIFF LZW (.bigtiff)</option><option value="BTIFFZ">BigTIFF ZIP (.bigtiff)</option><option value="PSD">Photoshop (.psd)</option><option value="PSB">Big Photoshop (.psb)</option></select><span id="m_imageformat_info" style="color:#336699;padding-left:4px;vertical-align:middle">Auto: LZW for 8bit, ZIP for 16bit images.</span><br></td></tr><tr id="m_jpeg_tablerow" style="display:none"><td><label id="m_jpegquality_label" for="m_jpegquality" style="vertical-align:middle">JPEG Quality:</label></td><td><input id="m_jpegquality" type="text" value="85%" style="width:60px; vertical-align:middle; padding:0px 3px; margin:0px" onchange="on_jpegquality_change()"><label id="m_jpegsubsamp_label" for="m_jpegsubsamp" style="vertical-align:middle;padding-left:2px">Subsampling:</label><select id="m_jpegsubsamp" style="vertical-align:middle"><option value="444">444 (best quality)</option><option value="422">422 (compromise)</option><option value="420" selected="selected">420 (default)</option><option value="411">411 (smallest)</option></select></td></tr><tr><td><label for="m_autolevel" style="vertical-align:middle">Auto-Level:</label></td><td><input id="m_autolevel" type="checkbox" style="vertical-align:middle;margin-left:0" checked="checked"><span style="color:#336699;vertical-align:middle">Automatic leveling based on the EXIF/XMP information.</span></td></tr></table></div></div></div></body><script>function ID(e){return document.getElementById(e)}function convertdroplet_open_args(){if(top.krpanotools_are_ready){var e=top.require("nw.gui"),t=e.App.argv,n,r;r=t?t.length|0:0;for(n=0;n<r;n++){var i=""+t[n];i.charAt(0)!="-"&&i!="Tools.exe"&&process_image(i)}}else setTimeout(convertdroplet_open_args,50)}function savesettings(e){var t={};on_outsize_change(),on_jpegquality_change();var n=ID("m_outsize"),r=ID("m_imageformat"),i=ID("m_jpegquality"),s=ID("m_jpegsubsamp"),o=ID("m_autolevel");t.outsize=n.value,t.imageformat=r.options[r.selectedIndex].value,t.jpegquality=parseInt(i.value),t.jpegsubsamp=s.options[s.selectedIndex].value,t.autolevel=o.checked;if(e===!0)return t;localStorage&&(localStorage.convert=JSON.stringify(t))}function loadsettings(){var e=ID("m_imageformat"),t=ID("m_jpegquality"),n=ID("m_jpegsubsamp"),r=ID("m_autolevel");if(localStorage&&localStorage.convert){var i=JSON.parse(localStorage.convert);i.imageformat!==undefined&&(e.value=i.imageformat),i.jpegquality!==undefined&&(t.value=i.jpegquality),i.jpegsubsamp!==undefined&&(n.value=i.jpegsubsamp),i.autolevel!==undefined&&(r.checked=i.autolevel),on_imageformat_change(),on_jpegquality_change()}}function on_imageformat_change(){var e=ID("m_imageformat"),t=e.options[e.selectedIndex].value,n=t.slice(0,4)=="JPEG";ID("m_jpegquality").disabled=!n,ID("m_jpegsubsamp").disabled=!n,ID("m_jpegquality_label").style.opacity=ID("m_jpegsubsamp_label").style.opacity=n?1:.5,ID("m_jpeg_tablerow").style.display=n?"":"none";var r="";if(t=="JPEGO")r="Optimized: Same quality but optimized encoding.";else if(t=="TIFFA"||t=="BTIFFA")r="Auto: LZW for 8bit, ZIP for 16bit images.";ID("m_imageformat_info").innerHTML=r,ID("m_imageformat_info").style.display=r?"":"none"}function on_outsize_change(){var e=ID("m_outsize"),t=parseInt(e.value),n=(""+e.value).indexOf("%")>0,r=(""+e.value).indexOf("px")>0;isNaN(t)||t<=0?e.value="100%":n||!r&&t<=400?(t>1e3&&(t=1e3),e.value=t+"%"):e.value=t+"px"}function on_jpegquality_change(){var e=ID("m_jpegquality"),t=parseFloat(e.value);isNaN(t)&&(t=85),t<1?t=1:t>100&&(t=100),e.value=t+"%"}function process_image(e){ping_cnt++,top.krpanotools.pingImage(e,null,function(t){if(t)try{var n=JSON.parse(t);n&&ping_images.push({filepath:e,pinginfo:n})}catch(r){}ping_done++,check_have_all_images()})}function check_have_all_images(){if(ping_cnt==ping_done){var e=cube_sphere_detector.detect_sets(ping_images);e&&e.length>0&&(ping_cnt=ping_done=0,ping_images=[],process_pano_sets(e))}}function getid(){return"uid_"+ ++unique_id_cnt}function set_done(e){e.done=!0,e.progress=100,e.node_progress.nodeValue="done",e.table_row.style.opacity=.5,e.node_info2.style.color="white"}function set_error(e,t){e.error=!0,e.progress=100,e.table_row.style.background="rgba(255,0,0,0.5)",e.node_info2.style.color="white",e.node_info2.style.fontSize="12px",e.node_info2.innerHTML=t,e.node_progress.nodeValue="ERROR"}function process_pano_sets(e){var t=savesettings(!0),n=document.getElementById("dropinfo"),r=document.getElementById("convertlog"),i=document.getElementById("processing_info"),s=document.getElementById("convert_table");for(var o=0;o<e.length;o++){var u=e[o];u.info_id=getid();var a=s.insertRow(-1);a.style.transition="opacity 0.5s";var f=a.insertCell(-1),l=a.insertCell(-1),c=a.insertCell(-1);f.style.width=(e.length<99?16:22)+"px",l.style.verticalAlign="top",c.style.width="44px",c.style.textAlign="right";var h=document.createTextNode(o+1+""),p=document.createTextNode("0%"),d=document.createElement("div");d.style.marginTop="2px";var v=document.createElement("div");v.style.fontSize="10px",v.style.marginBottom="2px",v.style.color="#AACCFF",f.appendChild(h),l.appendChild(d),l.appendChild(v),c.appendChild(p),u.table_row=a,u.node_num=h,u.node_info1=d,u.node_info2=v,u.node_progress=p;var m="",g="",y=null;if(u.type=="cube"){var b,w=0,E=null,S=null,x=null,T=null;for(var b=0;b<6;b++)if(u.images[b]&&u.images[b].cube){w++,u.images[b].pinginfo&&(T=u.images[b].pinginfo);var N=u.images[b].filepath,C=path.basename(N),k=u.images[b].cube.sideid;S==null&&(S=C,x=k);if(k.length==2&&k.charAt(0)=="_"){var L=N.lastIndexOf(k);L>0&&(E=[N.slice(0,L),N.slice(L+2)])}}else u.images[b]=null;if(w>0&w<6&&E){var A="lfrbud";w=0;for(var b=0;b<6;b++)if(!u.images[b]){var O=E[0]+"_"+A.charAt(b)+E[1];fs.existsSync(O)&&(u.images[b]={filepath:O},w++)}else w++}var M=S.lastIndexOf(x),_=S.slice(0,M)+"*"+S.slice(M+x.length);m=_;if(w<6)y="Not enough cube images! ("+w+"/6)";else{var D=u.spheresize_w,P=u.spheresize_h;if(t.outsize!="100%"){if(t.outsize.indexOf("%")>1){var H=parseFloat(t.outsize)/100;D*=H,P*=H}else D=parseInt(t.outsize),P=Math.round(D/2);D<2&&(D=2),P<1&&(P=1)}g="Cube "+u.cubesize+"x"+u.cubesize,g+=" &rArr; ",g+="Sphere "+D+"x"+P,g+=" ("+get_imageformat_ext(t.imageformat)+")"}}else{var B=u.cubesize;t.outsize!="100%"&&(t.outsize.indexOf("%")>1?B*=parseFloat(t.outsize)/100:B=parseInt(t.outsize),B<1&&(B=1)),m=path.basename(u.images[0].filepath),g="Sphere "+u.spheresize_w+"x"+u.spheresize_h,g+=" &rArr; ",g+="Cube "+B+"x"+B,g+=" ("+get_imageformat_ext(t.imageformat)+")"}d.innerHTML=m,v.innerHTML=g,y?(set_error(u,y),processing_pano_sets.push(u)):process_pano_set(t,u)}update_current_sets(),update_total_progress()}function get_imageformat_ext(e){var t=e.slice(0,4);return t=="JPEG"?"jpg":t=="TIFF"?"tif":t=="BTIF"?"bigtiff":t=="PSD"?"psd":t=="PSB"?"psb":t=="KRO"?"kro":t=="PNG"?"png":"tif"}function process_pano_set(e,t){t.done=!1,t.progress=0;if(t.type=="sphere"){processing_pano_sets.push(t);var n=t.images[0].filepath,r=path.dirname(n)+path.sep+t.basename+"."+get_imageformat_ext(e.imageformat),i=[];i.push("spheretocube"),i.push("cube"),i.push(top.krpanotools.encodeParam(n)),i.push(top.krpanotools.encodeParam(r));var s=t.cubesize;e.outsize!="100%"&&(i.push("-dontsavespheresize"),e.outsize.indexOf("%")>1?s*=parseFloat(e.outsize)/100:s=parseInt(e.outsize),s<1&&(s=1)),i.push("-outsize="+s),e.autolevel==0&&i.push("-noautolevel"),i.push("-jpegquality="+e.jpegquality),i.push("-jpegsubsamp="+e.jpegsubsamp),(e.imageformat=="JPEGO"||e.imageformat=="JPEGP")&&i.push("-jpegoptimize"),e.imageformat=="JPEGP"&&i.push("-jpegprogressive"),e.imageformat=="TIFFA"||e.imageformat=="BTIFFA"?i.push("-tiffcompress=auto"):e.imageformat=="TIFFU"||e.imageformat=="BTIFFU"?i.push("-tiffcompress=none"):e.imageformat=="TIFFL"||e.imageformat=="BTIFFL"?i.push("-tiffcompress=lzw"):(e.imageformat=="TIFFZ"||e.imageformat=="BTIFFZ")&&i.push("-tiffcompress=zip"),top.krpanotools.sendCommand(i.join(" "),function(e){},function(e){set_done(t),update_total_progress()},function(e){var n=e.indexOf("progress=");if(n>=0){var r=parseFloat(e.slice(n+9)),i=r.toFixed(0)+"%";t.node_progress.nodeValue=i,t.progress=r,update_total_progress()}else console.log(t.basename+" onprogress:"+e.split("\n").join(" "))},function(e){set_error(t,e)})}else if(t.type=="cube"&&t.images[0]&&t.images[1]&&t.images[2]&&t.images[3]&&t.images[4]&&t.images[5]){processing_pano_sets.push(t);var i=[];i.push("cubetosphere");var n=t.images[0].filepath,o=[path.dirname(n)+path.sep+t.basename,"."+get_imageformat_ext(e.imageformat)],r=o[0]+o[1],u=o[0]+"_sphere"+o[1];fs.existsSync(r)&&(r=u),i.push(top.krpanotools.encodeParam("-l="+t.images[0].filepath)),i.push(top.krpanotools.encodeParam("-f="+t.images[1].filepath)),i.push(top.krpanotools.encodeParam("-r="+t.images[2].filepath)),i.push(top.krpanotools.encodeParam("-b="+t.images[3].filepath)),i.push(top.krpanotools.encodeParam("-u="+t.images[4].filepath)),i.push(top.krpanotools.encodeParam("-d="+t.images[5].filepath)),i.push(top.krpanotools.encodeParam("-o="+r));var a=t.spheresize_w,f=t.spheresize_h;if(e.outsize!="100%"){if(e.outsize.indexOf("%")>1){var l=parseFloat(e.outsize)/100;a*=l,f*=l}else a=parseInt(e.outsize),f=Math.round(a/2);a<2&&(a=2),f<1&&(f=1)}i.push("-outsize="+a+"x"+f),i.push("-jpegquality="+e.jpegquality),i.push("-jpegsubsamp="+e.jpegsubsamp),(e.imageformat=="JPEGO"||e.imageformat=="JPEGP")&&i.push("-jpegoptimize"),e.imageformat=="JPEGP"&&i.push("-jpegprogressive"),e.imageformat=="TIFFA"||e.imageformat=="BTIFFA"?i.push("-tiffcompress=auto"):e.imageformat=="TIFFU"||e.imageformat=="BTIFFU"?i.push("-tiffcompress=none"):e.imageformat=="TIFFL"||e.imageformat=="BTIFFL"?i.push("-tiffcompress=lzw"):(e.imageformat=="TIFFZ"||e.imageformat=="BTIFFZ")&&i.push("-tiffcompress=zip"),top.krpanotools.sendCommand(i.join(" "),function(e){},function(e){set_done(t),update_total_progress()},function(e){var n=e.indexOf("progress=");if(n>=0){var r=parseFloat(e.slice(n+9)),i=r.toFixed(0)+"%";t.node_progress.nodeValue=i,t.progress=r,update_total_progress()}else console.log(t.basename+" onprogress:"+e.split("\n").join(" "))},function(e){set_error(t,e)})}}function update_current_sets(){var e=document.getElementById("convert_table"),t=processing_pano_sets.length,n;for(n=0;n<t;n++){var r=processing_pano_sets[n];r.done?(e.deleteRow(n),processing_pano_sets.splice(n,1),n--,t--):(r.error&&(r.done=!0),r.node_num.nodeValue=""+(n+1))}}function update_total_progress(){ID("convertdroplet").style.paddingTop=0,ID("convertlog").style.opacity=1;var e=processing_pano_sets.length,t,n=0,r=0,i=0;for(t=0;t<e;t++){var s=processing_pano_sets[t];if(s.error){i++;continue}var o=s.spheresize_w*s.spheresize_h;n+=o,r+=s.progress/100*o}if(n>0){var u=r/n*100;ID("processing_info").innerHTML="Processing: "+u.toFixed(0)+"%"}else ID("processing_info").innerHTML="&nbsp;";u==100&&i==0&&processing_done()}function processing_done(){setTimeout(function(){update_current_sets(),ID("convertdroplet").style.paddingTop="80px",ID("convertlog").style.opacity=0},1e3)}setTimeout(convertdroplet_open_args,50),top.convertdroplet_mode&&(ID("cf_top").style.display="none",ID("cf_wnd").style.padding="0",ID("dropletcontainer").style.border="0",ID("cf_bottom").style.display="none"),top.gui_style_do_system_fixes(document),top.gui_block_external_dragging(document);var path=top.require("path"),fs=top.require("fs"),ping_cnt=0,ping_done=0,ping_images=[],holder=document.getElementById("dropletcontainer");holder.ondragover=function(e){return e.preventDefault&&e.preventDefault(),!1},holder.ondragenter=function(){return holder.style.background="radial-gradient(ellipse at center, rgba(200,200,200,1) 0%,rgba(120,120,120,1) 0%,rgba(17,17,17,1) 100%)",!1},holder.ondragleave=function(){return holder.style.background="radial-gradient(ellipse at center, rgba(76,76,76,1) 0%,rgba(89,89,89,1) 0%,rgba(17,17,17,1) 100%)",!1},holder.ondrop=function(e){holder.ondragleave();if(e){e.preventDefault();if(e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length>0){var t,n;n=e.dataTransfer.files.length;for(t=0;t<n;t++){var r=e.dataTransfer.files[t];r&&r.path&&process_image(r.path)}}}return!1},top.gui_get_global().shutdownEvents.push(function(e){e&&savesettings()}),loadsettings();var processing_pano_sets=[],unique_id_cnt=0</script>