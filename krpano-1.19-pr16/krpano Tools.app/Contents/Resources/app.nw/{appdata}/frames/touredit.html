<!DOCTYPE html><head><title>krpano Make Pano</title><link rel="stylesheet" href="../design/style.css"><style>html{height:100%}body{height:100%;margin:0;padding:0}</style></head><body><div id="makepanoframe" style="position:absolute;width:100%;height:100%;display:table" onselectstart="return false"><div style="display:table-row;height:0"><div style="color:#336699;margin:10px 10px 5px 10px"><b>Virtual Tour Editor</b> - First make the tour using the MAKE VTOUR droplets, then open the tour.xml here for editing.<br><div style="padding-top:2px"><input id="btn_loadxml" type="button" value="Load tour.xml" onclick="load_tour_xml()" style="margin-left:0"><input id="btn_setview" type="button" value="Set as startup view" onclick="set_as_startup_view()"><input id="btn_addhs" type="button" value="Add hotspot" onclick="add_hotspot()"><input id="btn_ediths" type="button" value="Edit hotspots" onclick="h5_vtoureditor_edit_hotspots()"><input id="btn_editxml" type="button" value="Edit tour.xml" onclick="edit_tour_xml()"><input id="btn_savexml" type="button" value="Save tour.xml" onclick="save_tour_xml()"><input id="btn_openpath" type="button" value="Open tour folder" onclick="open_tour_folder()" style="margin-right:0"></div></div></div><div style="display:table-row; height:100%; xbackground-color:#77FFFF;position:relative"><table style="table-layout:fixed;font-size:inherit;margin:0;padding:0 0px;width:100%;height:100%" cellspacing="0"><tr style="height:100%"><td style="margin:0px;padding:0px 10px 10px 10px;vertical-align:top"><div id="pano_div" style="box-sizing:border-box;width:100%;height:100%;border:1px solid silver;background:black;color:white"></td></tr></table></div></div></body><script>function ID(e){return document.getElementById(e)}function savesettings(){localStorage&&(localStorage.edittool=JSON.stringify(settings))}function loadsettings(){var e=JSON.parse(localStorage.edittool||"null");settings.ui_last_add_folder=e?e.ui_last_add_folder:null}function set_buttons_state(e,t){var n=!e||t!==!0;e=!e,ID("btn_setview").disabled=n,ID("btn_addhs").disabled=n,ID("btn_ediths").disabled=n,ID("btn_editxml").disabled=e,ID("btn_savexml").disabled=e,ID("btn_openpath").disabled=e}function install_drag_and_drop_handler(e){e.ondragover=function(e){return e.preventDefault&&e.preventDefault(),!1},e.ondrop=function(e){if(e){e.preventDefault();if(e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length>0){var t=e.dataTransfer.files[0];if(t&&t.path){var n=t.path;n.indexOf(".xml")==n.length-4&&(tour_xml_path=path.dirname(n)+path.sep,tour_xml_filepath=""+n,settings.ui_last_add_folder=tour_xml_path,autoreload_watcher_reloaded=!1,embed_krpano_viewer(tour_xml_filepath))}}}return!1}}function embed_krpano_viewer(e,t){var n=path.dirname(e)+path.sep;removepano("krpano_viewer_object"),embedpano({swf:get_krpano_viewer_path("krpano.swf"),target:"pano_div",id:"krpano_viewer_object",consolelog:!0,html5:"webgl+only",focus:!0,vars:t,webglsettings:{preserveDrawingBuffer:!0,depth:!1,stencil:!1},xml:e,initvars:{"network.swfpath":n,"network.htmlpath":n},onready:krpano_ready})}function load_krpanojs_script(){var e=get_krpano_viewer_path("krpano.js?nocache="+(Math.random()*1e4|0)),t=document.createElement("script");t.onload=function(){var e=null,t=null;top.toureditor_startupxml&&(e=top.toureditor_startupxml,tour_xml_path=path.dirname(e)+path.sep,tour_xml_filepath=""+e,top.toureditor_fullscreen&&(t={fullscreen:!0})),embed_krpano_viewer(e,t)},t.onerror=function(t){top.fatalerror("Missing file:<br>"+e)},t.src=e,document.head.appendChild(t)}function autoreload_watcher_callback(){if(autoreload_watcher_skipnext){autoreload_watcher_skipnext=!1;return}krpano&&top&&top.vtoureditor_settings.reloadxml&&autoreload_watcher_file&&reload_via_reembedding(autoreload_watcher_file)}function reload_via_reembedding(e){if(krpano){e||(e=tour_xml_filepath);var t=krpano.get("scene[get(xml.scene)].name"),n=krpano.get("view");top.vtoureditor_autoreload_scene=t,top.vtoureditor_autoreload_actions="delayedcall(0,lookat("+n.hlookat+","+n.vlookat+","+n.fov+","+n.distortion+","+n.architectural+"));";var r={startscene:t,"events[_autoreload_].keep":"true","events[_autoreload_].onnewscene":"js( top.vtoureditor_autoreload_callback() );"};tour_xml_filepath=e,autoreload_watcher_reloaded=!0,embed_krpano_viewer(tour_xml_filepath,r)}}function autoreload_watcher(e){autoreload_watcher_file&&(fs.unwatchFile(autoreload_watcher_file),autoreload_watcher_file=null),e&&(autoreload_watcher_file=e,fs.watchFile(autoreload_watcher_file,{persistent:!1,interval:751},autoreload_watcher_callback))}function vtoureditor_fake_fullscreen_setup(){if(krpano){var e=krpano.get("fullscreen"),t=krpano.get("contextmenu.enterfs"),n=krpano.get("contextmenu.exitfs"),r=null,i=krpano.get("contextmenu.item").getArray(),s=i.length,o;for(var o=0;o<s;o++)(""+i[o].caption).toLowerCase()=="fullscreen"&&(r=i[o].name);s==0&&krpano.set("contextmenu.item[kr].caption","KRPANO"),r==null&&(r="fs"),krpano.set("contextmenu.item["+r+"].caption",e?n:t+"&nbsp;"),krpano.set("contextmenu.item["+r+"].onclick","switch(fullscreen);")}}function vtoureditor_fake_fullscreen(){if(krpano){var e=krpano.get("fullscreen");top.show_appmenu(!e);if(top&&top.vtoureditor_settings.fssupport){var t=top.require("nw.gui");e?t.Window.get().enterFullscreen():t.Window.get().leaveFullscreen()}}}function krpano_ready(e){krpano=e,krpano.set("device.vtoureditor",1),krpano.set("events[toureditor_fakefs].keep",!0),krpano.set("events[toureditor_fakefs].oncontextmenu",vtoureditor_fake_fullscreen_setup),krpano.set("events[toureditor_fakefs].onenterfullscreen",vtoureditor_fake_fullscreen),krpano.set("events[toureditor_fakefs].onexitfullscreen",vtoureditor_fake_fullscreen),tour_xml_filepath==null?(set_buttons_state(!1),krpano.set("xml.content","<krpano><preview type='grid(cube)'/><view fov='100'/></krpano>"),krpano.call("loadxml(get(xml.content));"),show_viewer_message("Load a tour.xml or drag-and-drop it here...",100),krpano.focus()):fs.readFile(tour_xml_filepath,"utf8",function(e,t){if(e)krpano.trace(3,e),set_buttons_state(!1);else{h5_vtoureditor_xml=t,h5_vtoureditor_xml=h5_vtoureditor_xml.split("\r\n").join("\n"),h5_vtoureditor_xml=h5_vtoureditor_xml.split("\n\r").join("\n"),h5_vtoureditor_xml=h5_vtoureditor_xml.split("\r").join("\n"),h5_vtoureditor_xml=h5_vtoureditor_xml.split("\ufeff").join(""),h5_vtoureditor_xml=h5_vtoureditor_xml.split("\u00ef\u00bb\u00bf").join(""),h5_vtoureditor_xmllow=h5_vtoureditor_xml.toLowerCase();var n=h5_vtoureditor_xmllow.indexOf("<krpano")>=0,r=h5_vtoureditor_xmllow.indexOf("vtourskin.xml")>0,i=h5_vtoureditor_xmllow.indexOf("<scene")>0,s=h5_vtoureditor_xmllow.indexOf("thumburl")>0;if(n&&r&&i&&s){set_buttons_state(!0,!0),krpano.set("vtoureditor.xml",h5_vtoureditor_xml),krpano.set("vtoureditor.modified",!1),krpano.set("vtoureditor.set_as_startup_view",h5_vtoureditor_set_as_startup_view),krpano.set("vtoureditor.add_hotspot",h5_vtoureditor_add_hotspot),krpano.set("vtoureditor.move_hotspots",h5_vtoureditor_move_hotspots),krpano.set("vtoureditor.delete_hotspots",h5_vtoureditor_delete_hotspots),krpano.set("vtoureditor.edit_xml",function(){}),krpano.set("vtoureditor.update_xml",function(){krpano.set("vtoureditor.xml",h5_vtoureditor_xml)});var o=top.krpanoviewer.getViewerFolder()+"plugins/combobox.xml";krpano.call("copy(currentscene, xml.scene);loadpano('//"+o+"',null,MERGE|KEEPALL|KEEPIMAGE|KEEPHOTSPOTS|KEEPSCENES|INCLUDE,NOBLEND);"+"loadscene(get(currentscene),null,MERGE|KEEPALL|KEEPIMAGE|KEEPHOTSPOTS|KEEPSCENES,NOBLEND);"+"")}else set_buttons_state(!0,!1),autoreload_watcher_reloaded==0&&show_viewer_message("Not a krpano MAKE VTOUR tour.xml file![br]No editing functionality available...",10),autoreload_watcher_reloaded=!1;top.vtoureditor_settings.reloadxml&&autoreload_watcher(tour_xml_filepath)}})}function load_tour_xml(){var e=settings.ui_last_add_folder;top.gui_dialogs.openFile(load_tour_xml_callback,e,!1,".xml")}function get_krpano_viewer_path(e){var t=top.krpanotools.get_krpanotools_basepath(),n="file://"+t+"viewer"+path.sep+e;return n=n.split("\\").join("/"),n}function load_tour_xml_callback(e,t){if(e){var n=e;tour_xml_path=path.dirname(n)+path.sep,tour_xml_filepath=""+n,settings.ui_last_add_folder=tour_xml_path,autoreload_watcher_reloaded=!1,embed_krpano_viewer(tour_xml_filepath)}}function set_as_startup_view(){krpano&&tour_xml_filepath&&(krpano.call("vtoureditor.set_as_startup_view()"),krpano.focus())}function add_hotspot(){krpano&&tour_xml_filepath&&(krpano.call("vtoureditor.add_hotspot()"),krpano.focus())}function move_hotspots(){krpano&&tour_xml_filepath&&(krpano.call("vtoureditor.move_hotspots()"),krpano.focus())}function delete_hotspots(){krpano&&tour_xml_filepath&&(krpano.call("vtoureditor.delete_hotspots()"),krpano.focus())}function edit_tour_xml(){if(krpano&&tour_xml_filepath){krpano.get("vtoureditor.modified")==1&&save_tour_xml();var e=top.nwrequire("nw.gui");e.Shell.openItem(tour_xml_filepath),krpano.focus()}}function dateToYMDT(e,t,n,r){var i=e.getDate(),s=e.getMonth()+1,o=e.getFullYear(),u=e.getHours(),a=e.getMinutes(),f=e.getSeconds();return""+o+t+(s<=9?"0"+s:s)+t+(i<=9?"0"+i:i)+n+(u<=9?"0"+u:u)+r+(a<=9?"0"+a:a)+r+(f<=9?"0"+f:f)}function save_tour_xml(){if(krpano&&tour_xml_filepath){krpano.call("vtoureditor.update_xml()"),krpano.focus();var e=krpano.get("vtoureditor.xml");e=e.split("\ufeff").join(""),e=e.split("\u00ef\u00bb\u00bf").join(""),top.ksystem.isWindows?(e=e.split("\r\n").join("\n"),e=e.split("\n\r").join("\n"),e=e.split("\r").join("\n"),e=e.split("\n").join("\r\n")):(e=e.split("\r\n").join("\n"),e=e.split("\n\r").join("\n"),e=e.split("\r").join("\n"));var t=tour_xml_filepath+" - backup-"+dateToYMDT(new Date,".","-",".")+".xml";top.vtoureditor_settings.backupxml!=1&&(t=null),autoreload_watcher_skipnext=!0;var n=top.process.mainModule.exports.replace_xml_file,r=n(tour_xml_filepath,t,e);r?krpano.call('error("'+r+'");'):show_viewer_message("Saving tour.xml...",.5),krpano.set("vtoureditor.modified",!1)}}function open_tour_folder(){if(krpano&&tour_xml_filepath){var e=top.nwrequire("nw.gui");e.Shell.showItemInFolder(tour_xml_filepath),krpano.focus()}}function url_to_path(e){e=e.split("\\").join("/");var t=e.indexOf("?");t>0&&(e=e.slice(0,t));var n=e.indexOf("#");return n>0&&(e=e.slice(0,n)),e}function update_thumburl_image(){var e=krpano.get("scene[get(xml.scene)].thumburl");if(!e)return;var t=null,n=krpano.get("global");if(!(n&&n.webGL&&n.webGL.makeScreenshot))return;t=n.webGL.makeScreenshot,e=url_to_path(e);var r,i=[],s=0,o=0,u=krpano.get("layer").getArray(),a=null,f=null;for(r=0;r<u.length;r++)a=u[r],a&&a.loader&&a.loader.src&&(f=a.url,f&&(f=url_to_path(f),f==e&&(i.push(a),s=a.loader.naturalWidth,o=a.loader.naturalHeight)));if(i.length>0&&s>0&&o>0){var l=t(s,o,!1,"jpeg",.85);if(l){var c=l.indexOf("base64,")+7;l=l.slice(c),fs.writeFile(e,l,"base64",function(e){if(e)krpano.trace(3,e);else for(r=0;r<i.length;r++)a=i[r],a&&a._destroyed!=1&&(f=a.url,f+=(f.indexOf("?")>0?"&":"?")+"nocache="+(Math.random()*1e4|0),a.url=f)})}}}function h5_vtoureditor_set_as_startup_view(){krpano.set("vtoureditor.modified",!0),top.vtoureditor_settings.rebuildthumbs&&update_thumburl_image();var e=krpano.get("scene[get(xml.scene)].name"),t=find_node_start(h5_vtoureditor_xmllow,"scene",e),n=-1;t>0&&(n=h5_vtoureditor_xmllow.indexOf("</scene>",t),n>t&&(n+=8));if(!(n>t)){krpano.trace(3,"No <scene> element with the name '"+e+"' found!");return}h5_vtoureditor_xml=replace_view(h5_vtoureditor_xml,t,n),h5_vtoureditor_xmllow=h5_vtoureditor_xml.toLowerCase();var r=krpano.get("scene[get(xml.scene)].content");r=replace_view(r,0,r.length),krpano.set("scene[get(xml.scene)].content",r),show_viewer_message("Saving the current view as startup view for this scene...",1)}function h5_vtoureditor_add_dragging_action(){krpano.set("action[vtoureditor_draghotspot].content","spheretoscreen(ath,atv,hcx,hcy);sub(adx,mouse.stagex,hcx);sub(ady,mouse.stagey,hcy);asyncloop(pressed,sub(hcx,mouse.stagex,adx);sub(hcy,mouse.stagey,ady);screentosphere(hcx,hcy,ath,atv);,if(vtoureditorspot == edit,vtoureditor_save_hotspots(get(name));););")}function show_viewer_message(e,t){krpano.call("stopdelayedcall(vtoureditor_message_fadeout);removelayer(vtoureditor_message);"),e&&krpano.call("addlayer(vtoureditor_message);set(layer[vtoureditor_message].type,text);set(layer[vtoureditor_message].align,top);set(layer[vtoureditor_message].y,16);set(layer[vtoureditor_message].enabled,false);set(layer[vtoureditor_message].zorder,999999);set(layer[vtoureditor_message].html,'"+e+"');"+"set(layer[vtoureditor_message].padding,'4 12');"+"set(layer[vtoureditor_message].bgroundedge,8);"+"set(layer[vtoureditor_message].bg,true);"+"set(layer[vtoureditor_message].bgcolor,0x555555);"+"set(layer[vtoureditor_message].bgalpha,0.5);"+"set(layer[vtoureditor_message].mergedalpha,false);"+"set(layer[vtoureditor_message].bgshadow,0 0 5 0x000000 1);"+"set(layer[vtoureditor_message].css,'text-align:center;color:#FFFFFF;font-family:Arial;font-size:14px;font-weight:bold;');"+"set(layer[vtoureditor_message].txtshadow,'0 1 2 0x000000 0.5');"+"set(layer[vtoureditor_message].onloaded,delayedcall(vtoureditor_message_fadeout,"+t+",tween(alpha,0,0.5,default,removelayer(get(name)))));"+"")}function h5_vtoureditor_install_hotspot_apis(){krpano.set("vtoureditor_add_hotspot_cancel",h5_vtoureditor_add_hotspot_cancel),krpano.set("vtoureditor_open_hotspot_editor",h5_vtoureditor_open_hotspot_editor),krpano.set("vtoureditor_save_hotspots",h5_vtoureditor_save_current_hotspots),krpano.set("events[vtoureditor_draghotspot].onremovepano","vtoureditor_add_hotspot_cancel()"),krpano.set("events[vtoureditor_draghotspot].onkeydown","if(keycode==27,vtoureditor_add_hotspot_cancel())"),krpano.set("events[vtoureditor_draghotspot].keep",!0),h5_vtoureditor_add_dragging_action()}function h5_vtoureditor_edit_hotspots(){h5_vtoureditor_install_hotspot_apis(),h5_vtoureditor_add_hotspot_cancel(),krpano.focus(),show_viewer_message("drag the hotspots...[br]or click on them for editing...",10);var e=krpano.get("hotspot").getArray();for(var t=0;t<e.length;t++){if(e[t]._poly)continue;(""+e[t].style).indexOf("skin_")>=0&&e[t].vtoureditorspot!="edit"&&(e[t].vtoureditorspot="edit",e[t].ondown="vtoureditor_draghotspot();",e[t].onclick="vtoureditor_open_hotspot_editor(get(name));")}}function h5_vtoureditor_add_hotspot_delete(){krpano.call("removelayer(vtoureditor_edit_hotspot_box_bg,true);");var e=krpano.get("vtoureditor_current_hotspot");e&&(e.vtoureditorspot!="new"&&(e.vtoureditorspot=="edit"||e.vtoureditorspot=="save")&&(h5_vtoureditor_delete_hotspot_from_xml(e.name),krpano.set("vtoureditor.modified",!0)),krpano.call("removehotspot("+e.name+")")),krpano.set("vtoureditor_current_hotspot",null),show_viewer_message(null)}function h5_vtoureditor_add_hotspot_cancel(){if(krpano.get("layer[vtoureditor_edit_hotspot_box_bg]")){krpano.call("removelayer(vtoureditor_edit_hotspot_box_bg,true);");return}var e=krpano.get("vtoureditor_current_hotspot");e&&(e.vtoureditorspot=="new"&&(krpano.call("removehotspot("+e.name+")"),show_viewer_message(null)),krpano.set("vtoureditor_current_hotspot",null))}function h5_vtoureditor_add_hotspot_save(){var e=krpano.get("scene[ get(layer[vtoureditor_edit_hotspot_combobox].selecteditemindex)].name");krpano.call("removelayer(vtoureditor_edit_hotspot_box_bg,true);");var t=krpano.get("vtoureditor_current_hotspot");t&&(t.vtoureditorspot="save",t.ondown=null,t.onclick=krpano.get("style[skin_hotspotstyle].onclick"),t.linkedscene=e,krpano.set("vtoureditor_current_hotspot",null),h5_vtoureditor_save_current_hotspots())}function h5_vtoureditor_save_current_hotspots(e){var t=krpano.get("scene[get(xml.scene)].name"),n=find_node_start(h5_vtoureditor_xmllow,"scene",t),r=-1;n>0&&(r=h5_vtoureditor_xmllow.indexOf("</scene>",n),r>n&&(r+=8));if(!(r>n)){krpano.trace(3,"No <scene> element with the name '"+t+"' found!");return}h5_vtoureditor_xml=h5_vtoureditor_update_hotspots(h5_vtoureditor_xml,n,r,e),h5_vtoureditor_xmllow=h5_vtoureditor_xml.toLowerCase();var i=krpano.get("scene[get(xml.scene)].content");i=h5_vtoureditor_update_hotspots(i,0,i.length,e),krpano.set("scene[get(xml.scene)].content",i),krpano.set("vtoureditor.modified",!0)}function h5_vtoureditor_update_hotspots(e,t,n,r){var i=e.slice(t,n).toLowerCase(),s=krpano.get("hotspot").getArray(),o,u,a=null,f=0,l,c,h=0;u=s.length,r&&(h=krpano.get("hotspot["+r+"].index"),u=h+1);for(o=h;o<u;o++){var p=s[o];if(!p)continue;if(p._poly)continue;var d=-1,v=-1,m=null;d=find_node_start(i,"hotspot",p.name),d>=0&&(v=i.indexOf("/>",d),v>d&&(v+=2,d+=t,v+=t,m=e.slice(d,v).toLowerCase()));if(m==null){if(p.vtoureditorspot&&String(p["vtoureditorspot"]).toLowerCase()=="save"){l=Number(p.ath).toFixed(3),c=Number(p.atv).toFixed(3),m='\n		<hotspot name="'+p.name+'" style="skin_hotspotstyle" ath="'+l+'" atv="'+c+'"'+(p.distorted==0?' distorted="false" zoom="false"':"")+' linkedscene="'+p.linkedscene+'" />';var g=i.lastIndexOf("</scene>");g>0?g=i.lastIndexOf(">",g-1):g=i.length-1,g>0&&(g+=1+t,f=m.length,e=e.slice(0,g)+m+e.slice(g),n+=f,i=e.slice(t,n).toLowerCase())}}else{a=null,f=0,l=Number(p.ath).toFixed(3),c=Number(p.atv).toFixed(3),a=get_attribute_value_cutter(m,"ath"),a&&(f=-(a[1]-a[0])+l.length,e=e.slice(0,d+a[0])+l+e.slice(d+a[1]),v+=f,n+=f,m=e.slice(d,v).toLowerCase()),a=get_attribute_value_cutter(m,"atv"),a&&(f=-(a[1]-a[0])+c.length,e=e.slice(0,d+a[0])+c+e.slice(d+a[1]),v+=f,n+=f,m=e.slice(d,v).toLowerCase()),a=get_attribute_value_cutter(m,"linkedscene");if(a){var y=""+p.linkedscene;f=-(a[1]-a[0])+y.length,e=e.slice(0,d+a[0])+y+e.slice(d+a[1]),v+=f,n+=f,m=e.slice(d,v).toLowerCase()}i=e.slice(t,n).toLowerCase()}}return e}function h5_vtoureditor_delete_hotspot_from_xml(e){var t=krpano.get("scene[get(xml.scene)].name"),n=find_node_start(h5_vtoureditor_xmllow,"scene",t),r=-1;n>0&&(r=h5_vtoureditor_xmllow.indexOf("</scene>",n),r>n&&(r+=8));if(!(r>n)){krpano.trace(3,"No <scene> element with the name '"+t+"' found!");return}h5_vtoureditor_xml=xml_delete_scene_hotspot(e,h5_vtoureditor_xml,n,r),h5_vtoureditor_xmllow=h5_vtoureditor_xml.toLowerCase();var i=krpano.get("scene[get(xml.scene)].content");i=xml_delete_scene_hotspot(e,i,0,i.length),krpano.set("scene[get(xml.scene)].content",i)}function xml_delete_scene_hotspot(e,t,n,r){var i=t.slice(n,r).toLowerCase(),s=-1,o=-1;s=find_node_start(i,"hotspot",e.toLowerCase());if(s>=0){o=i.indexOf("/>",s);if(o>s){o+=2,s+=n,o+=n;var u=o-s;t=t.slice(0,s)+t.slice(o)}}return t}function hs_add_button_style(){krpano.set("style[vtoureditor_button].type","text"),krpano.set("style[vtoureditor_button].css","text-align:center;"),krpano.set("style[vtoureditor_button].mergedalpha",!1),krpano.set("style[vtoureditor_button].bgborder","4 0xFFFFFF 1"),krpano.set("style[vtoureditor_button].bgroundedge","1"),krpano.set("style[vtoureditor_button].bgshadow","0 1 4 0x000000 1.0"),krpano.set("style[vtoureditor_button].onover","set(bgcolor, 0xC7E4FC);"),krpano.set("style[vtoureditor_button].onout","calc(bgcolor, pressed ? 0x90CAF9 : 0xFFFFFF);"),krpano.set("style[vtoureditor_button].ondown","set(bgcolor, 0x90CAF9);"),krpano.set("style[vtoureditor_button].onup","calc(bgcolor, hovering ? 0xC7E4FC : 0xFFFFFF);")}function h5_vtoureditor_open_hotspot_editor(e){hs_add_button_style();var t=krpano.get("global");krpano.set("vtoureditor_current_hotspot",krpano.get("hotspot["+e+"]"));var n=t.addlayer("vtoureditor_edit_hotspot_box_bg");n.type="container",n.align="lefttop",n.bgcolor=0,n.bgalpha=.5,n.bgcapture=!0,n.handcursor=!1,n.width="100%",n.height="100%",n.zorder=999999,n.onclick="combobox_closelist();";var r=t.addlayer("vtoureditor_edit_hotspot_box");r.parent=n.name,r.type="container",r.align="center",r.bgcolor=16777215,r.bgalpha=1,r.bgcapture=!0,r.handcursor=!1,r.width=400,r.height=184,r.mergedalpha=!1,r.bgborder="4 0xFFFFFF 1",r.bgroundedge=1,r.bgshadow="0 1 4 0x000000 1.0",r.onclick="combobox_closelist();";var i=t.addlayer("vtoureditor_edit_hotspot_box_title");i.parent=r.name,i.type="text",i.align="top",i.bg=!1,i.html="Edit Hotspot",i.css="color:#000000;font-size:14px;font-weight:bold;",i.y=10,i.ondown="copy(sx, layer[vtoureditor_edit_hotspot_box].ox);copy(sy, layer[vtoureditor_edit_hotspot_box].oy);copy(mx, mouse.x);copy(my, mouse.y);asyncloop(pressed,calc(layer[vtoureditor_edit_hotspot_box].ox, sx + mouse.x - mx);calc(layer[vtoureditor_edit_hotspot_box].oy, sy + mouse.y - my););";var s=t.addlayer("vtoureditor_edit_hotspot_box_text2");s.parent=r.name,s.type="text",s.align="top",s.bg=!1,s.width=-40,s.html="Select Hotspot Target:",s.css="color:#000000;font-size:12px;",s.y=40,s.enabled=!1;var o=t.addlayer("vtoureditor_edit_hotspot_box_b1_button");o.parent=r.name,o.type="text",o.width=100,o.height=20,o.vcenter=!0,o.align="bottom",o.html="Save",o.css="text-align:center;color:#000000;font-size:12px;",o.x=-127,o.y=18,o.loadstyle("vtoureditor_button"),o.onclick=h5_vtoureditor_add_hotspot_save;var u=t.addlayer("vtoureditor_edit_hotspot_box_b2_button");u.parent=r.name,u.type="text",u.width=100,u.height=20,u.vcenter=!0,u.align="bottom",u.html="Delete",u.css="text-align:center;color:#000000;font-size:12px;",u.x=0,u.y=18,u.loadstyle("vtoureditor_button"),u.onclick=h5_vtoureditor_add_hotspot_delete;var a=t.addlayer("vtoureditor_edit_hotspot_box_b3_button");a.parent=r.name,a.type="text",a.width=100,a.height=20,a.vcenter=!0,a.align="bottom",a.html="Cancel",a.css="text-align:center;color:#000000;font-size:12px;",a.x=127,a.y=18,a.loadstyle("vtoureditor_button"),a.onclick=h5_vtoureditor_add_hotspot_cancel,krpano.call("addComboboxLayer('vtoureditor_edit_hotspot_combobox');"),krpano.set("layer[vtoureditor_edit_hotspot_combobox].align","top"),krpano.set("layer[vtoureditor_edit_hotspot_combobox].edge","center"),krpano.set("layer[vtoureditor_edit_hotspot_combobox].parent",r.name),krpano.set("layer[vtoureditor_edit_hotspot_combobox].x",0),krpano.set("layer[vtoureditor_edit_hotspot_combobox].width",-40),krpano.set("layer[vtoureditor_edit_hotspot_combobox].y",93);var f=krpano.get("scene").getArray();for(var l=0;l<f.length;l++)krpano.set("itemcode",'[img src="'+f[l].thumburl+'" style="width:50px;height:50px;vertical-align:middle;padding-right:4px;"/] '+f[l].title),krpano.call("escape(itemcode);layer[vtoureditor_edit_hotspot_combobox].addItem(get(itemcode),null);");var c=krpano.get("scene[get(xml.scene)].index")+1;c>=f.length&&(c=0),krpano.call("layer[vtoureditor_edit_hotspot_combobox].selectItemByName("+c+")")}function h5_vtoureditor_add_hotspot(){h5_vtoureditor_install_hotspot_apis(),h5_vtoureditor_add_hotspot_cancel();var e=1,t="spot"+e;for(;;){var n=krpano.get("hotspot["+t+"]");if(!n)break;e++,t="spot"+e}var r=krpano.get("image.hfov")<10;krpano.call("addhotspot("+t+");"+"hotspot["+t+"].loadstyle(skin_hotspotstyle);"+"set(hotspot["+t+"].vtoureditorspot,new);"+"set(hotspot["+t+"].zorder,999);"+"copy(hotspot["+t+"].ath,view.hlookat);"+"copy(hotspot["+t+"].atv,view.vlookat);"+(r?"set(hotspot["+t+"].distorted,false);set(hotspot["+t+"].zoom,false);":"")+"set(hotspot["+t+"].ondown,vtoureditor_draghotspot());"+"set(hotspot["+t+"].onclick,vtoureditor_open_hotspot_editor(get(name)));"),krpano.set("vtoureditor_current_hotspot",krpano.get("hotspot["+t+"]")),show_viewer_message("drag the hotspot...[br]and click on it when finished...",10)}function h5_vtoureditor_move_hotspots(){}function h5_vtoureditor_delete_hotspots(){}function replace_view(e,t,n){var r=e.slice(t,n).toLowerCase(),i=-1,s=-1,o=null;i=find_node_start(r,"view"),i>=0&&(s=r.indexOf("/>",i),s>i&&(s+=2,i+=t,s+=t,o=e.slice(i,s).toLowerCase()));if(o==null)return e;var u=null,a=0,f=krpano.get("view.hlookat"),l=krpano.get("view.vlookat"),c=krpano.get("view.fov"),h=f.toFixed(3),p=l.toFixed(3),d=c.toFixed(3);return u=get_attribute_value_cutter(o,"hlookat"),u&&(a=-(u[1]-u[0])+h.length,e=e.slice(0,i+u[0])+h+e.slice(i+u[1]),s+=a,n+=a,o=e.slice(i,s).toLowerCase()),u=get_attribute_value_cutter(o,"vlookat"),u&&(a=-(u[1]-u[0])+p.length,e=e.slice(0,i+u[0])+p+e.slice(i+u[1]),s+=a,n+=a,o=e.slice(i,s).toLowerCase()),u=get_attribute_value_cutter(o,"fov"),u&&(a=-(u[1]-u[0])+d.length,e=e.slice(0,i+u[0])+d+e.slice(i+u[1]),s+=a,n+=a,o=e.slice(i,s).toLowerCase()),e}function find_node_start(e,t,n){var r=-1;t="<"+t;for(;;){r=e.indexOf(t,r);if(r>0)for(;;){if(!(e.charCodeAt(r+t.length)>32))break;r=e.indexOf(t,r+1);if(r<0)break}if(!(r>0))break;var i=e.indexOf(">",r);if(!i){r=-1;break}var s=e.slice(r-1,i);if(n==null)return r;var o=get_attribute_value_cutter(s,"name");if(o!=null){var u=s.slice(o[0],o[1]).toLowerCase();if(n.toLowerCase()==u.toLowerCase())return r;r=i+1}else r=i+1}return r}function get_attribute_value_cutter(e,t){var n=0;n=e.indexOf(t,n);while(n>1){var r=e.charCodeAt(n-1),i=e.charCodeAt(n+t.length);if(r<=32&&(i<=32||i==61))break;n=e.indexOf(t,n+1)}if(n>1){n+=t.length;var s=e.indexOf("'",n),o=e.indexOf('"',n);if(s<0||o>0&&o<s)s=o;if(s>0){o=e.indexOf(e.charAt(s),s+1);if(o>0)return[s+1,o]}}return null}var path=top.require("path"),fs=top.require("fs");top.gui_style_do_system_fixes(document),top.gui_block_external_dragging(document),set_buttons_state(!1);var settings={ui_last_add_folder:null};loadsettings();var krpano=null;install_drag_and_drop_handler(ID("pano_div")),load_krpanojs_script();var tour_xml_path=null,tour_xml_filepath=null,autoreload_watcher_file=null,autoreload_watcher_skipnext=!1,autoreload_watcher_reloaded=!1;top.addEventListener("beforeunload",function(){autoreload_watcher_file&&(fs.unwatchFile(autoreload_watcher_file),autoreload_watcher_file=null)},!0),top.vtoureditor_autoreload_scene=null,top.vtoureditor_autoreload_actions=null,top.vtoureditor_autoreload_callback=function(){if(krpano){var e=krpano.get("scene[get(xml.scene)].name");e==top.vtoureditor_autoreload_scene&&(top.vtoureditor_autoreload_scene=null,krpano.set("events[_autoreload_].name",null),top.vtoureditor_autoreload_actions&&(krpano.call(top.vtoureditor_autoreload_actions),top.vtoureditor_autoreload_actions=null)),show_viewer_message("The tour.xml has been changed - automatic reloading...",1)}};var h5_vtoureditor_xml=null,h5_vtoureditor_xmllow=null</script>